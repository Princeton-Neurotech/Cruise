{"version":3,"file":"adb.js","names":["ADBKit","isErrorWithCode","UsageError","WebExtError","createLogger","packageIdentifiers","defaultApkComponents","DEVICE_DIR_BASE","ARTIFACTS_DIR_PREFIX","defaultADB","default","log","import","meta","url","wrapADBCall","asyncFn","error","message","includes","ADBUtils","constructor","params","adb","adbBin","adbHost","adbPort","adbClient","createClient","bin","host","port","artifactsDirMap","Map","userAbortDiscovery","runShellCommand","deviceId","cmd","debug","JSON","stringify","getDevice","shell","then","util","readAll","res","toString","discoverDevices","devices","listDevices","map","dev","id","discoverInstalledFirefoxAPKs","firefoxApk","pmList","split","line","replace","trim","filter","browser","startsWith","getAndroidVersionNumber","androidVersion","androidVersionNumber","parseInt","isNaN","ensureRequiredAPKRuntimePermissions","apk","permissions","permissionsMap","perm","pmDumpLogs","amForceStopAPK","getOrCreateArtifactsDir","artifactsDir","get","Date","now","testDirOut","set","detectOrRemoveOldArtifacts","removeArtifactDirs","files","readdir","found","file","isDirectory","name","clearArtifactsDir","delete","pushFile","localPath","devicePath","push","transfer","Promise","resolve","on","startFirefoxAPK","apkComponent","deviceProfileDir","extras","key","value","component","startActivity","wait","action","setUserAbortDiscovery","discoverRDPUnixSocket","maxDiscoveryTime","retryInterval","rdpUnixSockets","discoveryStartedAt","msg","length","info","endsWith","setTimeout","pop","setupForward","remote","local","forward","listADBDevices","adbUtils","listADBFirefoxAPKs"],"sources":["../../src/util/adb.js"],"sourcesContent":["/* @flow */\nimport ADBKit from '@devicefarmer/adbkit';\n\nimport {\n  isErrorWithCode,\n  UsageError,\n  WebExtError,\n} from '../errors.js';\nimport {createLogger} from '../util/logger.js';\nimport packageIdentifiers, {\n  defaultApkComponents,\n} from '../firefox/package-identifiers.js';\n\nexport const DEVICE_DIR_BASE = '/data/local/tmp/';\nexport const ARTIFACTS_DIR_PREFIX = 'web-ext-artifacts-';\n\nconst defaultADB = ADBKit.default;\n\nconst log = createLogger(import.meta.url);\n\nexport type ADBUtilsParams = {|\n  adb?: typeof defaultADB,\n  // ADB configs.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n|};\n\nexport type DiscoveryParams = {\n  maxDiscoveryTime: number,\n  retryInterval: number,\n};\n\n// Helper function used to raise an UsageError when the adb binary has not been found.\nasync function wrapADBCall(asyncFn: (...any) => Promise<any>): Promise<any> {\n  try {\n    return await asyncFn();\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error) &&\n        error.message.includes('spawn adb')) {\n      throw new UsageError(\n        'No adb executable has been found. ' +\n          'You can Use --adb-bin, --adb-host/--adb-port ' +\n          'to configure it manually if needed.');\n    }\n\n    throw error;\n  }\n}\n\nexport default class ADBUtils {\n  params: ADBUtilsParams;\n  adb: typeof defaultADB;\n  adbClient: any; // TODO: better flow typing here.\n\n  // Map<deviceId -> artifactsDir>\n  artifactsDirMap: Map<string, string>;\n  // Toggled when the user wants to abort the RDP Unix Socket discovery loop\n  // while it is still executing.\n  userAbortDiscovery: boolean;\n\n  constructor(params: ADBUtilsParams) {\n    this.params = params;\n\n    const {\n      adb,\n      adbBin,\n      adbHost,\n      adbPort,\n    } = params;\n\n    this.adb = adb || defaultADB;\n\n    this.adbClient = this.adb.createClient({\n      bin: adbBin,\n      host: adbHost,\n      port: adbPort,\n    });\n\n    this.artifactsDirMap = new Map();\n\n    this.userAbortDiscovery = false;\n  }\n\n  runShellCommand(\n    deviceId: string, cmd: string | Array<string>\n  ): Promise<string> {\n    const {adb, adbClient} = this;\n\n    log.debug(`Run adb shell command on ${deviceId}: ${JSON.stringify(cmd)}`);\n\n    return wrapADBCall(async () => {\n      return await adbClient.getDevice(deviceId).shell(cmd).then(\n        adb.util.readAll\n      );\n    }).then((res) => res.toString());\n  }\n\n  async discoverDevices(): Promise<Array<string>> {\n    const {adbClient} = this;\n\n    let devices = [];\n\n    log.debug('Listing android devices');\n    devices = await wrapADBCall(async () => adbClient.listDevices());\n\n    return devices.map((dev) => dev.id);\n  }\n\n  async discoverInstalledFirefoxAPKs(\n    deviceId: string,\n    firefoxApk?: string\n  ): Promise<Array<string>> {\n    log.debug(`Listing installed Firefox APKs on ${deviceId}`);\n\n    const pmList = await this.runShellCommand(deviceId, [\n      'pm', 'list', 'packages',\n    ]);\n\n    return pmList.split('\\n')\n      .map((line) => line.replace('package:', '').trim())\n      .filter((line) => {\n        // Look for an exact match if firefoxApk is defined.\n        if (firefoxApk) {\n          return line === firefoxApk;\n        }\n        // Match any package name that starts with the package name of a Firefox for Android browser.\n        for (const browser of packageIdentifiers) {\n          if (line.startsWith(browser)) {\n            return true;\n          }\n        }\n\n        return false;\n      });\n  }\n\n  async getAndroidVersionNumber(deviceId: string): Promise<number> {\n    const androidVersion = (await this.runShellCommand(deviceId, [\n      'getprop', 'ro.build.version.sdk',\n    ])).trim();\n\n    const androidVersionNumber = parseInt(androidVersion);\n\n    // No need to check the granted runtime permissions on Android versions < Lollypop.\n    if (isNaN(androidVersionNumber)) {\n      throw new WebExtError(\n        'Unable to discovery android version on ' +\n        `${deviceId}: ${androidVersion}`\n      );\n    }\n\n    return androidVersionNumber;\n  }\n\n  // Raise an UsageError when the given APK does not have the required runtime permissions.\n  async ensureRequiredAPKRuntimePermissions(\n    deviceId: string, apk: string, permissions: Array<string>\n  ): Promise<void> {\n    const permissionsMap = {};\n\n    // Initialize every permission to false in the permissions map.\n    for (const perm of permissions) {\n      permissionsMap[perm] = false;\n    }\n\n    // Retrieve the permissions information for the given apk.\n    const pmDumpLogs = (await this.runShellCommand(deviceId, [\n      'pm', 'dump', apk,\n    ])).split('\\n');\n\n    // Set to true the required permissions that have been granted.\n    for (const line of pmDumpLogs) {\n      for (const perm of permissions) {\n        if (line.includes(`${perm}: granted=true`) ||\n            line.includes(`${perm}, granted=true`)) {\n          permissionsMap[perm] = true;\n        }\n      }\n    }\n\n    for (const perm of permissions) {\n      if (!permissionsMap[perm]) {\n        throw new UsageError(\n          `Required ${perm} has not be granted for ${apk}. ` +\n          'Please grant them using the Android Settings ' +\n          'or using the following adb command:\\n' +\n          `\\t adb shell pm grant ${apk} ${perm}\\n`\n        );\n      }\n    }\n  }\n\n  async amForceStopAPK(deviceId: string, apk: string): Promise<void> {\n    await this.runShellCommand(deviceId, [\n      'am', 'force-stop', apk,\n    ]);\n  }\n\n  async getOrCreateArtifactsDir(deviceId: string): Promise<string> {\n    let artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (artifactsDir) {\n      return artifactsDir;\n    }\n\n    artifactsDir = `${DEVICE_DIR_BASE}${ARTIFACTS_DIR_PREFIX}${Date.now()}`;\n\n    const testDirOut = (await this.runShellCommand(\n      deviceId, `test -d ${artifactsDir} ; echo $?`\n    )).trim();\n\n    if (testDirOut !== '1') {\n      throw new WebExtError(\n        `Cannot create artifacts directory ${artifactsDir} ` +\n        `because it exists on ${deviceId}.`\n      );\n    }\n\n    await this.runShellCommand(deviceId, ['mkdir', '-p', artifactsDir]);\n\n    this.artifactsDirMap.set(deviceId, artifactsDir);\n\n    return artifactsDir;\n  }\n\n  async detectOrRemoveOldArtifacts(\n    deviceId: string, removeArtifactDirs?: boolean = false\n  ): Promise<boolean> {\n    const {adbClient} = this;\n\n    log.debug('Checking adb device for existing web-ext artifacts dirs');\n\n    return wrapADBCall(async () => {\n      const files = await adbClient.getDevice(deviceId).readdir(\n        DEVICE_DIR_BASE\n      );\n      let found = false;\n\n      for (const file of files) {\n        if (!file.isDirectory() ||\n            !file.name.startsWith(ARTIFACTS_DIR_PREFIX)) {\n          continue;\n        }\n\n        // Return earlier if we only need to warn the user that some\n        // existing artifacts dirs have been found on the adb device.\n        if (!removeArtifactDirs) {\n          return true;\n        }\n\n        found = true;\n\n        const artifactsDir = `${DEVICE_DIR_BASE}${file.name}`;\n\n        log.debug(\n          `Removing artifacts directory ${artifactsDir} from device ${deviceId}`\n        );\n\n        await this.runShellCommand(deviceId, ['rm', '-rf', artifactsDir]);\n      }\n\n      return found;\n    });\n  }\n\n  async clearArtifactsDir(deviceId: string): Promise<void> {\n    const artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (!artifactsDir) {\n      // nothing to do here.\n      return;\n    }\n\n    this.artifactsDirMap.delete(deviceId);\n\n    log.debug(\n      `Removing ${artifactsDir} artifacts directory on ${deviceId} device`\n    );\n\n    await this.runShellCommand(deviceId, ['rm', '-rf', artifactsDir]);\n  }\n\n  async pushFile(\n    deviceId: string, localPath: string, devicePath: string\n  ): Promise<void> {\n    const {adbClient} = this;\n\n    log.debug(`Pushing ${localPath} to ${devicePath} on ${deviceId}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.getDevice(deviceId).push(localPath, devicePath)\n        .then(function(transfer) {\n          return new Promise((resolve) => {\n            transfer.on('end', resolve);\n          });\n        });\n    });\n  }\n\n  async startFirefoxAPK(\n    deviceId: string,\n    apk: string,\n    apkComponent: ?string,\n    deviceProfileDir: string,\n  ): Promise<void> {\n    const {adbClient} = this;\n\n    log.debug(\n      `Starting ${apk} on ${deviceId}`\n    );\n\n    // Fenix does ignore the -profile parameter, on the contrary Fennec\n    // would run using the given path as the profile to be used during\n    // this execution.\n    const extras = [{\n      key: 'args',\n      value: `-profile ${deviceProfileDir}`,\n    }];\n\n    if (!apkComponent) {\n      apkComponent = '.App';\n      if (defaultApkComponents[apk]) {\n        apkComponent = defaultApkComponents[apk];\n      }\n    } else if (!apkComponent.includes('.')) {\n      apkComponent = `.${apkComponent}`;\n    }\n\n    // if `apk` is a browser package or the `apk` has a\n    // browser package prefix: prepend the package identifier\n    // before `apkComponent`\n    if (apkComponent.startsWith('.')) {\n      for (const browser of packageIdentifiers) {\n        if (apk === browser || apk.startsWith(`${browser}.`)) {\n          apkComponent = browser + apkComponent;\n        }\n      }\n    }\n\n    // if `apkComponent` starts with a '.', then adb will expand\n    // the following to: `${apk}/${apk}.${apkComponent}`\n    const component = `${apk}/${apkComponent}`;\n\n    await wrapADBCall(async () => {\n      await adbClient.getDevice(deviceId).startActivity({\n        wait: true,\n        action: 'android.activity.MAIN',\n        component,\n        extras,\n      });\n    });\n  }\n\n  setUserAbortDiscovery(value: boolean) {\n    this.userAbortDiscovery = value;\n  }\n\n  async discoverRDPUnixSocket(\n    deviceId: string, apk: string,\n    {maxDiscoveryTime, retryInterval}: DiscoveryParams = {}\n  ): Promise<string> {\n    let rdpUnixSockets = [];\n\n    const discoveryStartedAt = Date.now();\n    const msg = (\n      `Waiting for ${apk} Remote Debugging Server...` +\n      '\\nMake sure to enable \"Remote Debugging via USB\" ' +\n      'from Settings -> Developer Tools if it is not yet enabled.'\n    );\n\n    while (rdpUnixSockets.length === 0) {\n      log.info(msg);\n      if (this.userAbortDiscovery) {\n        throw new UsageError(\n          'Exiting Firefox Remote Debugging socket discovery on user request'\n        );\n      }\n\n      if (Date.now() - discoveryStartedAt > maxDiscoveryTime) {\n        throw new WebExtError(\n          'Timeout while waiting for the Android Firefox Debugger Socket'\n        );\n      }\n\n      rdpUnixSockets = (await this.runShellCommand(deviceId, [\n        'cat', '/proc/net/unix',\n      ])).split('\\n').filter((line) => {\n        // The RDP unix socket is expected to be a path in the form:\n        //   /data/data/org.mozilla.fennec_rpl/firefox-debugger-socket\n        return line.trim().endsWith(`${apk}/firefox-debugger-socket`);\n      });\n\n      if (rdpUnixSockets.length === 0) {\n        await new Promise((resolve) => setTimeout(resolve, retryInterval));\n      }\n    }\n\n    // Convert into an array of unix socket filenames.\n    rdpUnixSockets = rdpUnixSockets.map((line) => {\n      return line.trim().split(/\\s/).pop();\n    });\n\n    if (rdpUnixSockets.length > 1) {\n      throw new WebExtError(\n        'Unexpected multiple RDP sockets: ' +\n        `${JSON.stringify(rdpUnixSockets)}`\n      );\n    }\n\n    return rdpUnixSockets[0];\n  }\n\n  async setupForward(deviceId: string, remote: string, local: string) {\n    const {adbClient} = this;\n\n    // TODO(rpl): we should use adb.listForwards and reuse the existing one if any (especially\n    // because adbkit doesn't seem to support `adb forward --remote` yet).\n    log.debug(`Configuring ADB forward for ${deviceId}: ${remote} -> ${local}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.getDevice(deviceId).forward(local, remote);\n    });\n  }\n}\n\nexport async function listADBDevices(adbBin?: string): Promise<Array<string>> {\n  const adbUtils = new ADBUtils({adbBin});\n  return adbUtils.discoverDevices();\n}\n\nexport async function listADBFirefoxAPKs(\n  deviceId: string,\n  adbBin?: string\n): Promise<Array<string>> {\n  const adbUtils = new ADBUtils({adbBin});\n  return adbUtils.discoverInstalledFirefoxAPKs(deviceId);\n}\n"],"mappings":"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"}